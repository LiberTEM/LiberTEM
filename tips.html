<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tips and tricks &mdash; LiberTEM 0.12.0.dev0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Package overview" href="packages.html" />
    <link rel="prev" title="Progress bar support" href="reference/progress.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            LiberTEM
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.12
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User manual</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">GUI usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="formats.html">Loading data</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample_datasets.html">Sample Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="udf.html">User-defined functions (UDFs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="dask.html">Dask integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">Acknowledgments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="reference/index.html">Python API reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tips and tricks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-ssh-forwarding">Using SSH forwarding</a></li>
<li class="toctree-l2"><a class="reference internal" href="#activating-ipywidgets-in-jupyter">Activating ipywidgets in Jupyter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-in-a-top-level-script">Running in a top-level script</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gatan-digital-micrograph-and-other-embedded-interpreters">Gatan Digital Micrograph and other embedded interpreters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#show-deprecation-warnings">Show deprecation warnings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#profiling-long-running-tests">Profiling long-running tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#platform-dependent-code-and-remote-executor">Platform-dependent code and remote executor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#benchmark-numba-compilation-time">Benchmark Numba compilation time</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simulating-slow-systems-with-control-groups">Simulating slow systems with control groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jupyter">Jupyter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jupyterhub">JupyterHub</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="packages.html">Package overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="why_python.html">Why Python?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dev/setup.html">Setting up a development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev/how-io-works.html">How does I/O work in LiberTEM?</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev/executors.html">LiberTEM executors</a></li>
<li class="toctree-l1"><a class="reference internal" href="authorship.html">Authorship policy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LiberTEM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tips and tricks</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tips.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tips-and-tricks">
<h1>Tips and tricks<a class="headerlink" href="#tips-and-tricks" title="Permalink to this heading"></a></h1>
<p>This is a collection of various helpful tips that don’t fit in elsewhere.</p>
<section id="using-ssh-forwarding">
<span id="ssh-forwarding"></span><h2>Using SSH forwarding<a class="headerlink" href="#using-ssh-forwarding" title="Permalink to this heading"></a></h2>
<p>As there is no built-in authentication yet, LiberTEM should not listen on a network
port where untrusted parties have access. You can use ssh port forwarding from <code class="code docutils literal notranslate"><span class="pre">localhost</span></code> instead
to access LiberTEM from a different computer.</p>
<p>For example with conda:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">9000</span>:localhost:9000<span class="w"> </span>&lt;remote-hostname&gt;<span class="w"> </span><span class="s2">&quot;conda activate libertem; libertem-server&quot;</span>
</pre></div>
</div>
<p>Or, with virtualenv:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ssh<span class="w"> </span>-L<span class="w"> </span><span class="m">9000</span>:localhost:9000<span class="w"> </span>&lt;remote-hostname&gt;<span class="w"> </span><span class="s2">&quot;/path/to/virtualenv/bin/libertem-server&quot;</span>
</pre></div>
</div>
<p>This makes LiberTEM, which is running on <code class="code docutils literal notranslate"><span class="pre">remote-hostname</span></code>, available on your
local host via <a class="reference external" href="http://localhost:9000/">http://localhost:9000/</a></p>
<p>Alternatively, you can launch and access LiberTEM on remote systems through
<a class="reference internal" href="deployment/jupyter.html#jupyter-integration"><span class="std std-ref">Jupyter integration</span></a>.</p>
</section>
<section id="activating-ipywidgets-in-jupyter">
<h2>Activating ipywidgets in Jupyter<a class="headerlink" href="#activating-ipywidgets-in-jupyter" title="Permalink to this heading"></a></h2>
<p>Some examples use <code class="code docutils literal notranslate"><span class="pre">ipywidgets</span></code> in notebooks, most notably the fast
<a class="reference internal" href="reference/viz.html#libertem.viz.bqp.BQLive2DPlot" title="libertem.viz.bqp.BQLive2DPlot"><code class="xref py py-class docutils literal notranslate"><span class="pre">BQLive2DPlot</span></code></a>. In some cases the corresponding Jupyter
Notebook extension <a class="reference external" href="https://ipywidgets.readthedocs.io/en/stable/user_install.html#installing-in-classic-jupyter-notebook">has to be activated manually</a>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>jupyter<span class="w"> </span>nbextension<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--py<span class="w"> </span>widgetsnbextension
</pre></div>
</div>
<p>For <a class="reference internal" href="reference/viz.html#libertem.viz.bqp.BQLive2DPlot" title="libertem.viz.bqp.BQLive2DPlot"><code class="xref py py-class docutils literal notranslate"><span class="pre">BQLive2DPlot</span></code></a> to function correctly in JupyterHub
and possibly JupyterLab, the packages <code class="code docutils literal notranslate"><span class="pre">bqplot</span></code> and <code class="code docutils literal notranslate"><span class="pre">bqplot-image-gl</span></code>
have to be installed in both the notebook environment and in the environment for
the notebook server. This might require admin privileges.</p>
</section>
<section id="running-in-a-top-level-script">
<h2>Running in a top-level script<a class="headerlink" href="#running-in-a-top-level-script" title="Permalink to this heading"></a></h2>
<p>Since LiberTEM uses multiprocessing, the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#the-spawn-and-forkserver-start-methods">script entry point may have to be
protected</a>,
most notably on Windows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Here goes starting a LiberTEM Context etc</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This is not necessary if LiberTEM is used in a Jupyter notebook or IPython.</p>
</section>
<section id="gatan-digital-micrograph-and-other-embedded-interpreters">
<h2>Gatan Digital Micrograph and other embedded interpreters<a class="headerlink" href="#gatan-digital-micrograph-and-other-embedded-interpreters" title="Permalink to this heading"></a></h2>
<p>If LiberTEM is run from within an embedded interpreter, the following steps
should be taken. This is necessary for Python scripting in Gatan Digital
Micrograph (GMS), for example.</p>
<p>The variable <code class="code docutils literal notranslate"><span class="pre">sys.argv</span></code> <a class="reference external" href="https://bugs.python.org/issue32573">may not be set in embedded interpreters</a>, but it is expected by the
<code class="code docutils literal notranslate"><span class="pre">multiprocessing</span></code> module when spawning new processes. This workaround
guarantees that <code class="code docutils literal notranslate"><span class="pre">sys.argv</span></code> is set <a class="reference external" href="https://github.com/python/cpython/pull/12463">until this is fixed upstream</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;argv&#39;</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>  <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Furthermore, the <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.set_executable">correct executable for spawning subprocesses</a>
has to be set.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">set_executable</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exec_prefix</span><span class="p">,</span> <span class="s1">&#39;pythonw.exe&#39;</span><span class="p">))</span>  <span class="c1"># Windows only</span>
</pre></div>
</div>
<p>In GMS the script may have to run in an additional thread since loading SciPy in
a GMS background thread doesn’t work. See <a class="reference external" href="https://www.gatan.com/python-faq">https://www.gatan.com/python-faq</a> for
more information.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Here goes the actual script</span>
    <span class="o">...</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Start the workload &quot;main()&quot; in a thread and wait for it to finish</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">main</span><span class="p">)</span>
    <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">th</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://github.com/LiberTEM/LiberTEM/tree/master/examples">our examples folder</a> for a number of
scripts that work in GMS!</p>
</section>
<section id="show-deprecation-warnings">
<span id="show-warnings"></span><h2>Show deprecation warnings<a class="headerlink" href="#show-deprecation-warnings" title="Permalink to this heading"></a></h2>
<p>Many warning messages via the <code class="code docutils literal notranslate"><span class="pre">warnings</span></code> built-in module are suppressed by
default, including in interactive shells such as IPython and Jupyter. If you’d
like to be informed early about upcoming backwards-incompatible changes, you
should activate deprecation warnings. This is recommended since LiberTEM is
under active development.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">PendingDeprecationWarning</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="profiling-long-running-tests">
<span id="profiling-tests"></span><h2>Profiling long-running tests<a class="headerlink" href="#profiling-long-running-tests" title="Permalink to this heading"></a></h2>
<p>Since our code base and test coverage is growing continuously, we should make
sure that our test suite remains efficient to finish within reasonable time
frames.</p>
<p>You can find the five slowest tests in the output of Tox, see <a class="reference internal" href="contributing.html#running-tests"><span class="std std-ref">Running the tests</span></a>
for details. If you are using <code class="code docutils literal notranslate"><span class="pre">pytest</span></code> directly, you can use the
<code class="code docutils literal notranslate"><span class="pre">--durations</span></code> parameter:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(libertem) $ pytest --durations=10 tests/
(...)
================= slowest 10 test durations =============================
31.61s call     tests/udf/test_blobfinder.py::test_run_refine_affinematch
17.08s call     tests/udf/test_blobfinder.py::test_run_refine_sparse
16.89s call     tests/test_analysis_masks.py::test_numerics_fail
12.78s call     tests/server/test_job.py::test_run_job_delete_ds
10.90s call     tests/server/test_cancel.py::test_cancel_udf_job
 8.61s call     tests/test_local_cluster.py::test_start_local
 8.26s call     tests/server/test_job.py::test_run_job_1_sum
 6.76s call     tests/server/test_job.py::test_run_with_all_zeros_roi
 6.50s call     tests/test_analysis_masks.py::test_numerics_succeed
 5.75s call     tests/test_analysis_masks.py::test_avoid_calculating_masks_on_client
= 288 passed, 66 skipped, 6 deselected, 2 xfailed, 7 warnings in 260.65 seconds =
</pre></div>
</div>
<p>Please note that tests which involve starting a local cluster have
long lead times that are hard to avoid.</p>
<p>In order to gain more information on what slows down a particular test, you can
install the <a class="reference external" href="https://github.com/man-group/pytest-plugins/tree/master/pytest-profiling">pytest-profiling extension</a> and
use it to profile individual slow tests that you identified before:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>(libertem) $ pytest --profile tests/udf/test_blobfinder.py::test_run_refine_affinematch
(...)
749921 function calls (713493 primitive calls) in 5.346 seconds

Ordered by: cumulative time
List reduced from 1031 to 20 due to restriction &lt;20&gt;

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
     1    0.000    0.000    5.346    5.346 runner.py:76(pytest_runtest_protocol)
 44/11    0.000    0.000    5.344    0.486 hooks.py:270(__call__)
 44/11    0.000    0.000    5.344    0.486 manager.py:65(_hookexec)
 44/11    0.000    0.000    5.344    0.486 manager.py:59(&lt;lambda&gt;)
 44/11    0.001    0.000    5.344    0.486 callers.py:157(_multicall)
     1    0.000    0.000    5.331    5.331 runner.py:83(runtestprotocol)
     3    0.000    0.000    5.331    1.777 runner.py:172(call_and_report)
     3    0.000    0.000    5.330    1.777 runner.py:191(call_runtest_hook)
     3    0.000    0.000    5.329    1.776 runner.py:219(from_call)
     3    0.000    0.000    5.329    1.776 runner.py:198(&lt;lambda&gt;)
     1    0.000    0.000    5.138    5.138 runner.py:119(pytest_runtest_call)
     1    0.000    0.000    5.138    5.138 python.py:1355(runtest)
     1    0.000    0.000    5.138    5.138 python.py:155(pytest_pyfunc_call)
     1    0.004    0.004    5.137    5.137 test_blobfinder.py:149(test_run_refine_affinematch)
     5    0.159    0.032    3.150    0.630 generate.py:6(cbed_frame)
   245    0.001    0.000    2.989    0.012 masks.py:98(circular)
   245    0.046    0.000    2.988    0.012 masks.py:8(_make_circular_mask)
   245    0.490    0.002    2.941    0.012 masks.py:280(radial_bins)
   245    0.152    0.001    2.229    0.009 masks.py:212(polar_map)
    25    0.001    0.000    1.968    0.079 blobfinder.py:741(run_refine)

=============================== 1 passed, 1 warnings in 7.81 seconds ============================
</pre></div>
</div>
</section>
<section id="platform-dependent-code-and-remote-executor">
<span id="os-mismatch"></span><h2>Platform-dependent code and remote executor<a class="headerlink" href="#platform-dependent-code-and-remote-executor" title="Permalink to this heading"></a></h2>
<p>Platform-dependent code in a lambda function or nested function can lead to
incompatibilities when run on an executor with remote workers, such as the
<a class="reference internal" href="dev/executors.html#libertem.executor.dask.DaskJobExecutor" title="libertem.executor.dask.DaskJobExecutor"><code class="xref py py-class docutils literal notranslate"><span class="pre">DaskJobExecutor</span></code></a>. Instead, the function should
be defined as part of a module, for example as a stand-alone function or as a
method of a class. That way, the correct remote implementation for
platform-dependent code is used on the remote worker since only a reference to
the function and not the implementation itself is sent over.</p>
</section>
<section id="benchmark-numba-compilation-time">
<h2>Benchmark Numba compilation time<a class="headerlink" href="#benchmark-numba-compilation-time" title="Permalink to this heading"></a></h2>
<p>One has to capture the very first execution of a jitted function and compare it
with subsequent executions to measure its compilation time. By default,
pytest-benchmark performs calibration runs and possibly warmup rounds that don’t
report the very first run.</p>
<p>The only way to completely disable this is to use the <a class="reference external" href="https://pytest-benchmark.readthedocs.io/en/latest/pedantic.html">pedantic mode</a> specifying
no warmup rounds and two rounds with one iteration each:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@numba</span><span class="o">.</span><span class="n">njit</span>
 <span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
     <span class="k">return</span> <span class="s2">&quot;world&quot;</span>


 <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">compilation</span>
 <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">benchmark</span><span class="p">(</span>
     <span class="n">group</span><span class="o">=</span><span class="s2">&quot;compilation&quot;</span>
 <span class="p">)</span>
 <span class="k">def</span> <span class="nf">test_numba_compilation</span><span class="p">(</span><span class="n">benchmark</span><span class="p">):</span>
     <span class="n">benchmark</span><span class="o">.</span><span class="n">extra_info</span><span class="p">[</span><span class="s2">&quot;mark&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;compilation&quot;</span>
     <span class="n">benchmark</span><span class="o">.</span><span class="n">pedantic</span><span class="p">(</span><span class="n">hello</span><span class="p">,</span> <span class="n">warmup_rounds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>That way the maximum is the first run with compilation, and the minimum is the
second one without compilation. Tests are marked as compilation tests in the
extra info as well to aid later data evaluation. Note that the compilation tests
will have poor statistics since it only runs once. If you have an idea on how to
collect better statistics, please <a class="reference external" href="https://github.com/LiberTEM/LiberTEM/issues/new">let us know</a>!</p>
</section>
<section id="simulating-slow-systems-with-control-groups">
<h2>Simulating slow systems with control groups<a class="headerlink" href="#simulating-slow-systems-with-control-groups" title="Permalink to this heading"></a></h2>
<p>Under Linux, it is possible to simulate a slow system using control groups:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>cgcreate<span class="w"> </span>-g<span class="w"> </span>cpu:/slow
sudo<span class="w"> </span>cgset<span class="w"> </span>-r<span class="w"> </span>cpu.cfs_period_us<span class="o">=</span><span class="m">1000000</span><span class="w"> </span>slow
sudo<span class="w"> </span>cgset<span class="w"> </span>-r<span class="w"> </span>cpu.cfs_quota_us<span class="o">=</span><span class="m">200000</span><span class="w"> </span>slow
sudo<span class="w"> </span>chown<span class="w"> </span>root:&lt;yourgroup&gt;<span class="w"> </span>/sys/fs/cgroup/cpu,cpuacct/slow
sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">664</span><span class="w"> </span>/sys/fs/cgroup/cpu,cpuacct/slow
</pre></div>
</div>
<p>Then, as a user, you can use <code class="code docutils literal notranslate"><span class="pre">cgexec</span></code> to run a command in that control group:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cgexec<span class="w"> </span>-g<span class="w"> </span>cpu:slow<span class="w"> </span>pytest<span class="w"> </span>tests/
</pre></div>
</div>
<p>This is useful, for example, to debug test failures that only seem to happen in CI
or under heavy load. Note that tools like <code class="code docutils literal notranslate"><span class="pre">cgcreate</span></code> only work with cgroups v1,
with newer distributions using cgroups v2 you may have to adapt these instructions.</p>
</section>
<section id="jupyter">
<span id="jupyter-install"></span><h2>Jupyter<a class="headerlink" href="#jupyter" title="Permalink to this heading"></a></h2>
<p>To use the Python API from within a Jupyter notebook, you can install Jupyter
into your LiberTEM virtual environment.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>libertem<span class="o">)</span><span class="w"> </span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>jupyter
</pre></div>
</div>
<p>You can then run a local notebook from within the LiberTEM environment, which
should open a browser window with Jupyter that uses your LiberTEM environment.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>libertem<span class="o">)</span><span class="w"> </span>$<span class="w"> </span>jupyter<span class="w"> </span>notebook
</pre></div>
</div>
</section>
<section id="jupyterhub">
<span id="jupyterhub-install"></span><h2>JupyterHub<a class="headerlink" href="#jupyterhub" title="Permalink to this heading"></a></h2>
<p>If you’d like to use the Python API from a LiberTEM virtual environment on a
system that manages logins with JupyterHub, you can easily <a class="reference external" href="https://ipython.readthedocs.io/en/stable/install/kernel_install.html">install a custom
kernel definition</a> for
your LiberTEM environment.</p>
<p>First, you can launch a terminal on JupyterHub from the “New” drop-down menu in
the file browser. Alternatively you can execute shell commands by prefixing them
with “!” in a Python notebook.</p>
<p>In the terminal you can create and activate virtual environments and perform the
LiberTEM installation as described above. Within the activated LiberTEM
environment you additionally install ipykernel:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>libertem<span class="o">)</span><span class="w"> </span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>ipykernel
</pre></div>
</div>
<p>Now you can create a custom ipython kernel definition for your environment:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">(</span>libertem<span class="o">)</span><span class="w"> </span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>ipykernel<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>--name<span class="w"> </span>libertem<span class="w"> </span>--display-name<span class="w"> </span><span class="s2">&quot;Python (libertem)&quot;</span>
</pre></div>
</div>
<p>After reloading the file browser window, a new Notebook option “Python
(libertem)” should be available in the “New” drop-down menu. You can test it by
creating a new notebook and running</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">libertem</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="deployment/jupyter.html#jupyter-integration"><span class="std std-ref">Jupyter integration</span></a> for launching the web GUI from JupyterHub or JupyterLab.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="reference/progress.html" class="btn btn-neutral float-left" title="Progress bar support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="packages.html" class="btn btn-neutral float-right" title="Package overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, LiberTEM Authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>